{% extends "base.html" %}

{% block title %}My Library{% endblock %}

{% block content %}
<div class="bg-linen p-10">
    <h1 class="text-3xl font-bold text-pumpkin">My Library</h1>
    {% if username_missing %}
        <p class="text-red-500 mt-4">Please enter your username to view your library.</p>
    {% endif %}

    <!-- Username Form -->
    <div class="flex items-center gap-4">
        <span class="font-medium">Username:</span>
        <form 
            id="username-form" 
            method="GET" 
            action="{{ url_for('library.all_pieces') }}" 
            class="ml-4"
        >
            <input 
               type="text"
               name="user_name"
               class="username-input border rounded px-3 py-2 focus:ring-2 focus:ring-pumpkin focus:outline-none whitespace-nowrap overflow-visible"
               style="min-width: 250px; width: 100%;"
               placeholder="Enter username here..."
               value="{{ user_name if user_name else '' }}"
               required
            >
        </form>
    </div>

    <!-- Search Box -->
    <div class="flex items-center gap-4">
        <span class="font-medium">Search:</span>
        <input 
            type="text" 
            class="search-input border rounded px-3 py-2 focus:ring-2 focus:ring-pumpkin focus:outline-none" 
            placeholder="Search by title..." 
            oninput="debouncedSearch(this.value)"
        >
    </div>

    <ul class="mt-6">
        {% if pieces %}
            {% for piece in pieces %}
            <li class="work-item"
                data-title="{{ piece.title }}"
                data-composer="{{ piece.composer }}">
                <div class="composer-name">{{ piece.composer }}</div>
                <div class="work-info">
                    <strong class="work-title">{{ piece.title }}</strong>
                    {% if piece.opus_number %}
                        <em>({{ piece.opus_number }})</em>
                    {% endif %}
                </div>
                <a href="https://www.youtube.com/results?search_query={{ piece.composer }}+{{ piece.title }}"
                   class="action-button youtube-button"
                   target="_blank"
                   title="Search on YouTube">‚ñ∂</a>
                <a href="{{ url_for('library.single_piece', piece_id=piece.id) }}"
                   class="action-button"
                   title="View Details">üëÅ</a>
            </li>
            {% endfor %}
        {% else %}
            <li class="no-results">No pieces in the library yet.</li>
        {% endif %}
    </ul>
</div>

<script>
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function searchLibrary(searchTerm) {
        const works = document.querySelectorAll('.work-item');
        searchTerm = searchTerm.toLowerCase();

        works.forEach(work => {
            const title = work.dataset.title.toLowerCase();
            const composer = work.dataset.composer.toLowerCase();
            const shouldShow = title.includes(searchTerm) || composer.includes(searchTerm);
            work.style.display = shouldShow ? 'block' : 'none';
        });
    }

    const debouncedSearch = debounce(searchLibrary, 200);
</script>

{% endblock %}